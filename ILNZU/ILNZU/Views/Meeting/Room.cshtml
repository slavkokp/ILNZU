@using DAL.Models
@using Microsoft.AspNetCore.Http;
@model List<Message>

<div id="header"></div>
<br />

<div class="container">
    <div class="row">
        <div class="col-md-4 offset-md-4">
            <div class="scroll-chat">
                <div id="chatroom">
                    @foreach (var msg in Model)
                    {
                        string sender = msg.DateTime + " " + msg.User.Name + ": ";
                        <p>
                            <b>@sender</b>
                            @msg.Text
                        </p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<br />
<form enctype="multipart/form-data">
    <div class="col-md-4 offset-md-4">
        <div class="message-input">
            <div id="inputForm">
                <input type="text" id="message" placeholder="Type a message" />
                <input type="button" id="sendBtn" value="Send" />
                <input type="file" id="attachment" value="upload" />
            </div>
        </div>
    </div>
</form>



<script src="~/js/signalr/dist/browser/signalr.min.js"></script>
<script>
    const hubConnection = new signalR.HubConnectionBuilder()
        .withUrl("/chat")
        .build();

    hubConnection.on("Receive", function (message, userName) {

        let time = new Date(message.datetime);

        let userNameElem = document.createElement("b");
        userNameElem.appendChild(document.createTextNode(time.toLocaleString().replace(',', '') + " " + userName + ": "));

        let elem = document.createElement("p");
        elem.appendChild(userNameElem);
        elem.appendChild(document.createTextNode(message.text));

        document.getElementById("chatroom").appendChild(elem);
    });

    function uploadFiles(file) {
        var formData = new FormData();
        formData.append("file", file)

        $.ajax(
            {
                url: '@Url.Action("CreateAttachment", "Meeting")',
                data: formData,
                processData: false,
                contentType: false,
                type: "POST",
                success: function (data) {
                    alert("Files Uploaded!");
                }
            }
        );
    }

    document.getElementById("sendBtn").addEventListener("click", function (e) {
        let text = document.getElementById("message").value;
        let input = document.getElementById("attachment")
        let file = input.files[0];
        if (file != null) {
            input.value = null
            uploadFiles(file);
            alert("@ViewBag.MeetingRoomId")
            alert("@ViewBag.AttachmentId")
            alert(text)
            hubConnection.invoke("Send", { "text": text }, @ViewBag.MeetingRoomId, @ViewBag.AttachmentId);
        }
        @*else {
            hubConnection.invoke("Send", { "text": text }, @ViewBag.MeetingRoomId, null);
        }*@

    });

    hubConnection.start().then(function () {
        hubConnection.invoke("SetGroup", @ViewBag.MeetingRoomId);
    });
</script>
